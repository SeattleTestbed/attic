\appendix

The following Seattle program measures network latency to a list of IP
addresses and displays a webpage showing the latency to each
node. This program has 30 lines of code, with 11 lines of
comments. Without the webpage functionality the program is only 21
lines of code. This is a complete Seattle program --- no code is
omitted or abbreviated.

%\caption{This Seattle program pings a list of nodes and gathers latency 
%information.   The user can browse the computer to see a HTML document
%that displays the latency information in a table. }

%\begin{figure}
{
%  # I'm going to write a HTML header first...
%  # and we're done, so let's close this connection...
%  # now the footer...
\scriptsize
\begin{verbatim}
# send a probe message to each neighbor
def probe_neighbors(port):
  for neighborip in mycontext["neighborlist"]:
    mycontext['sendtime'][neighborip] = getruntime()
    sendmess(neighborip, port, 'ping',getmyip(),port)
  # probe again in 10 seconds
  settimer(10,probe_neighbors,(port,))

# handle an incoming message
def got_message(srcip,srcport,mess,ch):
  if mess == 'ping':
    sendmess(srcip,srcport,'pong')
  elif mess == 'pong':
    # elapsed time is now - time when I sent the ping
    mycontext['latency'][srcip] = getruntime() - \
                         mycontext['sendtime'][srcip]

# display a web page with the latency information
def show_status(srcip,srcport,connobj, ch, mainch): 
  connobj.send("<html><head><title>Latency Information</title>"+ \
           "</head><body><h1>Latency information from "+ \
           getmyip()+' </h1><table border="1">')
  # list a row for each node we are talking to 
  for neighborip in mycontext['neighborlist']:
    if neighborip in mycontext['latency']:
      connobj.send("<tr><td>"+neighborip+"</td><td>"+ \
           str(mycontext['latency'][neighborip])+"<td></tr>")
    else:
      connobj.send("<tr><td>"+neighborip+"</td><td>Unknown<td></tr>")
  connobj.send("</table></html>")
  connobj.close()

if callfunc == 'initialize':
  # this holds the response information (i.e. when nodes responded)
  mycontext['latency'] = {}
  # this remembers when we sent a probe
  mycontext['sendtime'] = {}
  # get the nodes to probe
  mycontext['neighborlist'] = []
  for line in file("neighboriplist.txt"):
    mycontext['neighborlist'].append(line.strip())
  # call gotmessage whenever receiving a message
  pingport = int(callargs[0])
  recvmess(getmyip(),pingport,got_message)  
  
  probe_neighbors(pingport)

  # register a function to show a status webpage
  pageport = int(callargs[1])
  waitforconn(getmyip(),pageport,show_status)  
\end{verbatim}
}
%\end{figure}
